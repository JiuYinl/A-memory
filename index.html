<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Galaxy - Multi-Import Support</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- Ê†∏ÂøÉÂ≠ó‰ΩìÔºöÁ≥ªÁªüÂéüÁîüÊó†Ë°¨Á∫ø --- */
        :root {
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            
            /* üåô Â§úÊôöÊ®°Âºè */
            --bg-color: #050508;
            --bg-gradient: radial-gradient(circle at 20% 30%, #2f2f4a 0%, transparent 40%),
                           radial-gradient(circle at 80% 70%, #1d2a4c 0%, transparent 40%),
                           radial-gradient(circle at 50% 50%, #000000 0%, #13131f 100%);
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            
            --modal-bg: rgba(10, 10, 15, 0.95);
            --modal-border: rgba(100, 200, 255, 0.2);
            --modal-shadow: 0 0 50px rgba(0, 50, 150, 0.2);
            
            --accent-color: #ffffff; 
            --dot-user: #ffffff;
            --dot-bot: #ffffff;
            
            --code-bg: rgba(255, 255, 255, 0.05);
            --inline-code-bg: rgba(255, 255, 255, 0.15);
        }

        [data-theme="day"] {
            /* ‚òÄÔ∏è ÁôΩÂ§©Ê®°Âºè */
            --bg-color: #fdfbff;
            --bg-gradient: radial-gradient(at 10% 10%, rgba(236, 200, 232, 0.5) 0px, transparent 50%),
                           radial-gradient(at 90% 90%, rgba(194, 229, 252, 0.5) 0px, transparent 50%),
                           radial-gradient(at 50% 50%, rgba(226, 211, 248, 0.3) 0px, transparent 60%),
                           linear-gradient(to bottom, #fafdff, #f5f5fa);
            
            --text-primary: #334155;
            --text-secondary: #64748b;
            
            --modal-bg: rgba(255, 255, 255, 0.95);
            --modal-border: #e2e8f0; 
            --modal-shadow: 0 20px 50px rgba(200, 100, 200, 0.1);
            
            --accent-color: #000000; 
            --dot-user: #000000;
            --dot-bot: #000000;

            --code-bg: rgba(0, 0, 0, 0.04);
            --inline-code-bg: rgba(0, 0, 0, 0.06);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-primary);
            font-family: var(--font-stack);
            transition: background 1s ease, color 1s ease;
            -webkit-font-smoothing: antialiased;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        .interactive { pointer-events: auto; }

        /* --- Ê®°ÊÄÅÊ°Ü --- */
        #chat-modal, #name-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chat-modal.active, #name-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-content-wrapper, .name-modal-wrapper {
            background: var(--modal-bg);
            border: 1px solid var(--modal-border);
            box-shadow: var(--modal-shadow);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }
        
        .chat-content-wrapper {
            width: 85%;
            max-width: 900px;
            height: 85%;
        }

        .name-modal-wrapper {
            width: 90%;
            max-width: 400px;
            padding: 30px;
        }

        #chat-modal.active .chat-content-wrapper, #name-modal.active .name-modal-wrapper {
            transform: scale(1) translateY(0);
        }

        #chat-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            scroll-behavior: smooth;
        }
        
        #chat-scroll-area.hide-names .message-name {
            display: none;
        }

        @media (max-width: 640px) {
            #chat-scroll-area { padding: 30px 20px; }
            .chat-content-wrapper { width: 95%; height: 90%; }
        }

        /* --- Ê∂àÊÅØË°å --- */
        .message-row {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
            align-items: flex-start;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .role-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 24px;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 90%;
            min-width: 0; 
        }

        .message-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .message-content {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .message-row.assistant { flex-direction: row; }
        .message-row.assistant .role-dot {
            background-color: var(--dot-bot);
            box-shadow: 0 0 10px var(--dot-bot);
        }

        .message-row.user { flex-direction: row-reverse; }
        .message-row.user .role-dot {
            background-color: var(--dot-user);
            box-shadow: 0 0 10px var(--dot-user);
        }
        .message-row.user .message-container { align-items: flex-end; }
        .message-row.user .message-name { text-align: right; }

        /* --- Markdown Ê†∑Âºè --- */
        .markdown-body {
            font-size: 1rem;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .markdown-body p { margin-bottom: 1em; }
        
        .markdown-body strong, 
        .markdown-body b { 
            font-weight: 800 !important; 
            color: inherit;
        }
        
        .markdown-body em, .markdown-body i { font-style: italic !important; }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
            font-weight: 700 !important; 
            margin: 1.5em 0 0.5em 0; 
            line-height: 1.2; 
        }
        .markdown-body h1 { font-size: 1.8em; }
        .markdown-body h2 { font-size: 1.5em; }
        .markdown-body h3 { font-size: 1.25em; }
        
        .markdown-body ul { list-style-type: disc !important; padding-left: 1.5em !important; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal !important; padding-left: 1.5em !important; margin-bottom: 1em; }
        .markdown-body li { display: list-item !important; margin-bottom: 0.25em; }
        
        .markdown-body blockquote { 
            border-left: 4px solid var(--modal-border); 
            padding: 0.5em 0 0.5em 1em; 
            color: var(--text-secondary); 
            margin: 1em 0;
            background: rgba(127,127,127,0.05);
        }

        .markdown-body :not(pre) > code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            background-color: var(--inline-code-bg) !important;
            color: var(--accent-color) !important;
            word-break: break-all;
        }

        .code-wrapper {
            position: relative;
            margin: 1.5em 0;
            border: 1px solid var(--modal-border);
            border-radius: 8px;
            background-color: var(--code-bg);
            overflow: hidden;
        }
        
        .code-wrapper pre {
            margin: 0;
            padding: 1.5em;
            padding-top: 2.5em;
            overflow-x: hidden; 
            white-space: pre-wrap !important; 
            word-wrap: break-word !important; 
            color: var(--text-primary);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .code-lang {
            position: absolute;
            top: 0.5em;
            right: 1em;
            font-size: 0.7em;
            color: var(--text-secondary);
            opacity: 0.7;
            text-transform: lowercase;
        }

        #chat-scroll-area::-webkit-scrollbar { width: 5px; }
        #chat-scroll-area::-webkit-scrollbar-thumb { background: var(--text-secondary); opacity: 0.3; border-radius: 10px; }

        #upload-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            z-index: 50;
            transition: opacity 0.5s;
        }
        .upload-card {
            background: var(--modal-bg);
            border: 1px solid var(--modal-border);
            box-shadow: var(--modal-shadow);
            backdrop-filter: blur(10px);
            padding: 50px;
            text-align: center;
            border-radius: 20px;
            max-width: 450px;
        }
        
        .name-input {
            width: 100%;
            background: rgba(0,0,0,0.1);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            outline: none;
        }
        [data-theme="night"] .name-input { background: rgba(255,255,255,0.05); }

    </style>
</head>
<body>

    <canvas id="galaxy-canvas"></canvas>

    <div id="ui-layer">
        <div id="toolbar" class="absolute top-0 left-0 w-full p-6 flex justify-between items-center opacity-0 transition-opacity duration-500" style="pointer-events: none;">
            <div class="interactive flex items-center gap-4">
                <h1 class="text-xl font-bold tracking-widest opacity-80">MEMORY CLOUD</h1>
            </div>
            
            <div class="interactive flex gap-4 items-center">
                <div class="relative group">
                    <input type="text" id="search-box" placeholder="Search Memory..." class="bg-transparent border-b border-[var(--text-secondary)] px-2 py-1 text-sm focus:outline-none focus:border-[var(--accent-color)] transition w-48 text-right text-[var(--text-primary)] opacity-60 hover:opacity-100 placeholder-opacity-50">
                </div>
                 <button onclick="openNameModal()" class="p-2 opacity-60 hover:opacity-100 transition rounded-full hover:bg-[var(--text-secondary)]/10" title="Import More">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                </button>
                <button onclick="toggleTheme()" class="p-2 opacity-60 hover:opacity-100 transition rounded-full hover:bg-[var(--text-secondary)]/10">
                    <i data-lucide="moon" id="theme-icon"></i>
                </button>
            </div>
        </div>

        <div id="upload-screen">
            <div class="upload-card interactive">
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 rounded-full bg-[var(--accent-color)]/20 flex items-center justify-center animate-pulse">
                        <i data-lucide="cloud" class="w-8 h-8 text-[var(--accent-color)]"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-2 tracking-wide text-[var(--text-primary)]">ÈáèÂ≠êËÆ∞ÂøÜ‰∫ë</h2>
                <p class="text-sm text-[var(--text-secondary)] mb-8">Ready to Initialize</p>
                <button onclick="openNameModal()" class="px-8 py-3 rounded-lg border border-[var(--modal-border)] hover:bg-[var(--accent-color)]/10 hover:border-[var(--accent-color)] transition text-sm font-bold tracking-widest uppercase text-[var(--text-primary)]">
                    Load Data
                </button>
            </div>
        </div>
    </div>

    <div id="name-modal">
        <div class="name-modal-wrapper interactive" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-6 text-[var(--text-primary)] text-center">Identity Configuration</h3>
            <label class="block text-xs text-[var(--text-secondary)] mb-2 uppercase tracking-wider">AI Name</label>
            <input type="text" id="ai-name-input" class="name-input" placeholder="e.g. GPT-4o,Claude">
            <label class="block text-xs text-[var(--text-secondary)] mb-2 uppercase tracking-wider">User Name</label>
            <input type="text" id="user-name-input" class="name-input" placeholder="e.g. User">
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="closeNameModal()" class="px-4 py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)]">Cancel</button>
                <button onclick="confirmNameAndSelectFile()" class="px-6 py-2 rounded bg-[var(--accent-color)]/10 border border-[var(--modal-border)] text-[var(--text-primary)] text-sm font-bold hover:bg-[var(--accent-color)]/20 transition">
                    Select File
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".json" hidden>

    <div id="chat-modal">
        <div class="chat-content-wrapper interactive" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-[var(--modal-border)] flex justify-between items-center bg-transparent z-10">
                <div class="flex-1 min-w-0 mr-4">
                    <h2 id="modal-title" class="text-xl font-bold truncate text-[var(--text-primary)]">Untitled</h2>
                    <p id="modal-date" class="text-xs text-[var(--text-secondary)] mt-1 tracking-widest">LOADING...</p>
                </div>
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2" title="Toggle Name Display">
                        <span class="text-[10px] uppercase tracking-widest text-[var(--text-secondary)] hidden sm:block">Names</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="name-toggle" class="sr-only peer" checked onchange="toggleNames(this.checked)">
                            <div class="w-8 h-4 bg-[var(--text-secondary)]/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[var(--accent-color)]"></div>
                        </label>
                    </div>
                    <button onclick="closeModal()" class="p-2 rounded-full hover:bg-[var(--text-secondary)]/10 transition">
                        <i data-lucide="x" class="w-6 h-6 text-[var(--text-primary)]"></i>
                    </button>
                </div>
            </div>
            <div id="chat-scroll-area"></div>
        </div>
    </div>

    <script>
        // --- Marked Configuration ---
        const renderer = new marked.Renderer();
        renderer.code = function(code, infostring) {
            const lang = (infostring || '').match(/\S*/)[0];
            const content = typeof code === 'string' ? code : code.text;
            const escapedContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const langLabel = lang ? `<div class="code-lang">${lang}</div>` : '';
            return `<div class="code-wrapper">${langLabel}<pre><code class="language-${lang}">${escapedContent}</code></pre></div>`;
        };
        marked.setOptions({ renderer: renderer, breaks: true, gfm: true });

        // --- Ê†∏ÂøÉÈÖçÁΩÆ ---
        const CONFIG = {
            baseRepulsion: 120, // Á®çÂæÆÂ¢ûÂä†Êñ•ÂäõÔºåËÆ©ÂØºÂÖ•Êõ¥Â§öÊñá‰ª∂Êó∂‰∏ç‰ºöÂ§™Êå§
            zoomExtent: [0.1, 8],
            cloudRadiusMult: 4.5,
            particlesPerNode: 15,
            labelFadeStart: 1.5,
            labelFadeFull: 3.0
        };

        const PALETTE = {
            night: {
                core: ['#ffffff', '#e2e8f0'],
                cloudStops: [
                    { pos: 0, color: 'rgba(56, 189, 248, 0.4)' },
                    { pos: 0.4, color: 'rgba(129, 140, 248, 0.1)' },
                    { pos: 1, color: 'rgba(0, 0, 0, 0)' }
                ],
                particle: 'rgba(255, 255, 255, 0.6)'
            },
            day: {
                core: ['#ffffff', '#ffffff'],
                cloudStops: [
                    { pos: 0, color: 'rgba(244, 114, 182, 0.3)' },
                    { pos: 0.5, color: 'rgba(192, 132, 252, 0.1)' },
                    { pos: 1, color: 'rgba(255, 255, 255, 0)' }
                ],
                particle: 'rgba(255, 255, 255, 0.9)'
            }
        };

        let currentTheme = 'night';
        let simulation;
        let nodes = [];
        let width, height;
        let transform = d3.zoomIdentity;
        let activeNode = null;
        let targetNode = null;
        let isNameVisible = true;
        let tempAIName = "";
        let tempUserName = "";

        const canvas = document.getElementById('galaxy-canvas');
        const ctx = canvas.getContext('2d');
        lucide.createIcons();

        const zoomBehavior = d3.zoom()
            .scaleExtent(CONFIG.zoomExtent)
            .on("zoom", (e) => { transform = e.transform; });

        d3.select(canvas).call(zoomBehavior).on("dblclick.zoom", null);

        function init() {
            resize();
            window.addEventListener('resize', resize);
            renderLoop();
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            if(simulation) {
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        }

        const fileInput = document.getElementById('file-input');
        const uploadScreen = document.getElementById('upload-screen');
        const toolbar = document.getElementById('toolbar');
        const nameModal = document.getElementById('name-modal');
        const aiNameInput = document.getElementById('ai-name-input');
        const userNameInput = document.getElementById('user-name-input');

        function openNameModal() { nameModal.classList.add('active'); }
        function closeNameModal() { nameModal.classList.remove('active'); }

        function confirmNameAndSelectFile() {
            tempAIName = aiNameInput.value.trim() || "AI";
            tempUserName = userNameInput.value.trim() || "User";
            closeNameModal();
            fileInput.click();
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
            e.target.value = ''; 
        });

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    processData(json, tempAIName, tempUserName);
                    if (uploadScreen.style.display !== 'none') {
                        uploadScreen.style.opacity = 0;
                        setTimeout(() => {
                            uploadScreen.style.display = 'none';
                            toolbar.classList.remove('opacity-0');
                            toolbar.style.pointerEvents = 'auto';
                        }, 500);
                    }
                } catch (err) { alert('JSONËß£ÊûêÂ§±Ë¥•: ' + err); }
            };
            reader.readAsText(file);
        }

        function processData(data, aiName, userName) {
            // Á°Æ‰øù data ÊòØÊï∞ÁªÑ
            const rawArray = Array.isArray(data) ? data : [data];
            
            const newNodes = rawArray.filter(c => {
                // Â¢ûÂº∫Âà§ÂÆöÔºöÂè™Ë¶ÅÊúâ mapping (GPT) Êàñ chat_messages (Claude) Â∞±ÈÄöËøá
                return c.mapping || (c.chat_messages && Array.isArray(c.chat_messages)) || c.messages;
            }).map((chat, i) => {
                let id, title, rawDate, sizeScore;
                
                if (chat.mapping) { // ChatGPT
                    id = chat.id || chat.conversation_id;
                    title = chat.title || "Untitled Conversation";
                    rawDate = chat.create_time;
                    sizeScore = Object.keys(chat.mapping).length;
                } else if (chat.chat_messages || chat.messages) { // Claude (‰∏çÂêåÂØºÂá∫ÁâàÊú¨ÂèØËÉΩÂè´ messages)
                    const msgs = chat.chat_messages || chat.messages;
                    id = chat.uuid || chat.id;
                    title = chat.name || chat.title || "Untitled Conversation";
                    rawDate = chat.created_at || chat.create_time;
                    sizeScore = msgs.length * 3;
                }

                let dateVal = typeof rawDate === 'number' ? (rawDate > 1e11 ? rawDate/1000 : rawDate) : (new Date(rawDate).getTime() / 1000 || Date.now() / 1000);
                const r = Math.min(Math.max(sizeScore / 8, 2.5), 7);
                
                const cloudParticles = Array.from({length: CONFIG.particlesPerNode}, () => {
                    const dist = Math.abs(Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random())) * r * 1.5;
                    const angle = Math.random() * Math.PI * 2;
                    return { x: Math.cos(angle) * dist, y: Math.sin(angle) * dist, size: Math.random() * 1.2 + 0.3, alpha: Math.random() * 0.5 + 0.2 };
                });

                return {
                    id: id || Math.random().toString(36),
                    // Êñ∞ÊòüÊòü‰∫ßÁîüÂú®ËßÜÂõæ‰∏≠ÂøÉÈôÑËøëÔºåÈò≤Ê≠¢È£ûÂá∫
                    x: width/2 + (Math.random()-0.5)*100,
                    y: height/2 + (Math.random()-0.5)*100,
                    r: r,
                    cloudParticles: cloudParticles,
                    title: title,
                    date: dateVal,
                    chatData: chat,
                    colorIndex: nodes.length + i,
                    customAIName: aiName,
                    customUserName: userName
                };
            });

            if (newNodes.length === 0) {
                alert("Êú™ÂèëÁé∞ÊúâÊïàÁöÑÂØπËØùÊï∞ÊçÆÔºåËØ∑Á°ÆËÆ§ÊòØÂê¶‰∏∫ÂØºÂá∫ÁöÑ ChatGPT Êàñ Claude JSON Êñá‰ª∂„ÄÇ");
                return;
            }

            // ËøΩÂä†ËäÇÁÇπ
            nodes = nodes.concat(newNodes);

            // ÈáçÊñ∞ÁªëÂÆöÊàñÂêØÂä®‰ªøÁúü
            if (!simulation) {
                simulation = d3.forceSimulation(nodes)
                    .force("charge", d3.forceManyBody().strength(-CONFIG.baseRepulsion))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => d.r * CONFIG.cloudRadiusMult * 0.45))
                    .alphaDecay(0.02);
            } else {
                simulation.nodes(nodes);
                // ÊØèÊ¨°ËøΩÂä†Êó∂Áªô‰∏ÄÁÇπÂä®Âäõ
                simulation.alpha(0.6).restart();
            }
            
            canvas.addEventListener('click', onCanvasClick);
        }

        function renderLoop() {
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);
            const palette = PALETTE[currentTheme];
            let labelAlpha = transform.k > CONFIG.labelFadeStart ? Math.min((transform.k - CONFIG.labelFadeStart) / (CONFIG.labelFadeFull - CONFIG.labelFadeStart), 1) : 0;

            nodes.forEach(node => {
                const opacity = (activeNode && activeNode !== node) ? 0.1 : 1;
                ctx.globalAlpha = opacity;
                const cloudRadius = node.r * CONFIG.cloudRadiusMult;
                const gradient = ctx.createRadialGradient(node.x, node.y, node.r * 0.5, node.x, node.y, cloudRadius);
                palette.cloudStops.forEach(stop => gradient.addColorStop(stop.pos, stop.color));
                ctx.fillStyle = gradient;
                ctx.beginPath(); ctx.arc(node.x, node.y, cloudRadius, 0, Math.PI * 2); ctx.fill();

                if (transform.k > 0.4 || activeNode === node) {
                    ctx.fillStyle = palette.particle;
                    node.cloudParticles.forEach(p => {
                        ctx.globalAlpha = p.alpha * opacity;
                        ctx.beginPath(); ctx.arc(node.x + p.x, node.y + p.y, p.size, 0, Math.PI * 2); ctx.fill();
                    });
                }
                ctx.globalAlpha = opacity;
                ctx.fillStyle = palette.core[node.colorIndex % palette.core.length];
                if(currentTheme === 'night') { ctx.shadowBlur = (targetNode === node) ? 30 : 15; ctx.shadowColor = ctx.fillStyle; }
                ctx.beginPath(); ctx.arc(node.x, node.y, node.r * 0.8, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
                
                if (labelAlpha > 0 && !activeNode) {
                    ctx.globalAlpha = labelAlpha;
                    ctx.fillStyle = currentTheme === 'night' ? '#ccc' : '#555';
                    ctx.font = '2.5px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(node.title.substring(0, 15) + (node.title.length>15 ? '...' : ''), node.x, node.y + node.r * 2 + 3);
                }
            });
            ctx.restore();
            requestAnimationFrame(renderLoop);
        }

        function onCanvasClick(e) {
            const clickX = (e.clientX - transform.x) / transform.k;
            const clickY = (e.clientY - transform.y) / transform.k;
            let clickedNode = null;
            for (let i = nodes.length - 1; i >= 0; i--) {
                const node = nodes[i];
                const dx = clickX - node.x; const dy = clickY - node.y;
                if (dx*dx + dy*dy < (node.r * 4) * (node.r * 4)) { clickedNode = node; break; }
            }
            if (clickedNode) openNode(clickedNode); else if (activeNode) closeModal();
        }

        function openNode(node) {
            activeNode = node;
            const targetScale = 2.5;
            const targetX = width / 2 - node.x * targetScale;
            const targetY = height / 2 - node.y * targetScale;
            d3.select(canvas).transition().duration(800).call(zoomBehavior.transform, d3.zoomIdentity.translate(targetX, targetY).scale(targetScale));

            const modal = document.getElementById('chat-modal');
            const scrollArea = document.getElementById('chat-scroll-area');
            document.getElementById('modal-title').innerText = node.title;
            document.getElementById('modal-date').innerText = new Date(node.date * 1000).toLocaleString();
            
            renderChatContent(node.chatData, scrollArea, node.customAIName, node.customUserName);
            document.getElementById('name-toggle').checked = isNameVisible;
            toggleNames(isNameVisible);
            modal.classList.add('active');
            toolbar.style.opacity = '0';
        }

        function closeModal() {
            document.getElementById('chat-modal').classList.remove('active');
            activeNode = null; targetNode = null;
            toolbar.style.opacity = '1';
        }

        document.getElementById('search-box').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const term = e.target.value.toLowerCase();
                if (!term) return;
                const match = nodes.find(n => n.title.toLowerCase().includes(term));
                if (match) {
                    targetNode = match;
                    const searchScale = 3.5; 
                    const targetX = width / 2 - match.x * searchScale;
                    const targetY = height / 2 - match.y * searchScale;
                    d3.select(canvas).transition().duration(1200).call(zoomBehavior.transform, d3.zoomIdentity.translate(targetX, targetY).scale(searchScale));
                }
            }
        });

        function toggleNames(checked) {
            isNameVisible = checked;
            const area = document.getElementById('chat-scroll-area');
            if(checked) area.classList.remove('hide-names'); else area.classList.add('hide-names');
        }

        function renderChatContent(chat, container, aiName, userName) {
            container.innerHTML = '';
            try {
                let messages = [];
                // 1. GPT ÈÄªËæë
                if (chat.mapping) {
                    let currentNode = chat.current_node;
                    while (currentNode) {
                        const node = chat.mapping[currentNode];
                        if (node && node.message && node.message.content && node.message.content.parts) {
                            const role = node.message.author.role;
                            const rawText = node.message.content.parts.join('\n');
                            if (rawText.trim() !== '' && (role === 'user' || role === 'assistant')) {
                                messages.unshift({ role, content: rawText });
                            }
                        }
                        currentNode = node ? node.parent : null;
                    }
                } 
                // 2. Claude ÈÄªËæë (ÂÖºÂÆπ‰∏çÂêåÁâàÊú¨Ê†áËØÜ)
                else {
                    const msgs = chat.chat_messages || chat.messages;
                    if (msgs && Array.isArray(msgs)) {
                        messages = msgs.map(msg => {
                            // Claude ÂØºÂá∫‰∏≠ÔºåÂèëÈÄÅËÄÖÂèØËÉΩÊòØ 'human'/'assistant' Êàñ 'user'/'assistant'
                            let role = (msg.sender === 'assistant' || msg.author?.role === 'assistant') ? 'assistant' : 'user';
                            let text = msg.text || (msg.content?.[0]?.text) || "";
                            return { role, content: text };
                        }).filter(m => m.content && m.content.trim() !== '');
                    }
                }

                if (messages.length === 0) {
                    container.innerHTML = `<div class="text-center opacity-30 mt-20">No conversation found in this star.</div>`;
                    return;
                }

                messages.forEach(msg => {
                    const row = document.createElement('div');
                    row.className = `message-row ${msg.role}`;
                    const dot = document.createElement('div');
                    dot.className = 'role-dot';
                    const containerDiv = document.createElement('div');
                    containerDiv.className = 'message-container';
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'message-name';
                    nameDiv.innerText = msg.role === 'assistant' ? aiName : userName;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content markdown-body';
                    contentDiv.innerHTML = marked.parse(msg.content);
                    containerDiv.appendChild(nameDiv);
                    containerDiv.appendChild(contentDiv);
                    row.appendChild(dot);
                    row.appendChild(containerDiv);
                    container.appendChild(row);
                });
                container.querySelectorAll('a').forEach(a => a.target = '_blank');
            } catch (err) { container.innerHTML = `<div class="text-center text-red-400 mt-10">Render error: ${err.message}</div>`; }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'night' ? 'day' : 'night';
            document.documentElement.setAttribute('data-theme', currentTheme);
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', currentTheme === 'day' ? 'moon' : 'sun');
            lucide.createIcons();
            if(!activeNode) renderLoop(); 
        }

        init();
    </script>
</body>
</html>
